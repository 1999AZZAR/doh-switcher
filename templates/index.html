<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DoH Switcher</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script>
        // Tailwind Configuration
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'm-purple': {
                            '50': '#f4efff', '100': '#eaddff', '200': '#d0bcff', '300': '#b69df8',
                            '400': '#9a7ff0', '500': '#7f67ea', '600': '#6750a4', '700': '#523f82',
                            '800': '#3c2d61', '900': '#271c40'
                        },
                        'm-green': '#69de8a', 'm-red': '#ff8a8a', 'm-orange': '#ffca7b',
                        'm-blue': '#7ac0ff', 'm-teal': '#6ae8d3'
                    },
                    borderRadius: { 'xl': '1rem', '2xl': '1.5rem', '3xl': '2rem' },
                    backdropBlur: { 'xl': '24px' }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-m-purple-50 via-purple-50 to-indigo-100 text-gray-800 font-sans">
    <!-- Navbar -->
    <nav class="sticky top-0 z-40 bg-m-purple-100/80 backdrop-blur-lg shadow-sm mb-6">
        <div class="container mx-auto px-4 py-3">
            <a href="#" class="text-xl font-semibold text-m-purple-900">DoH Switcher</a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 pb-10">
        <!-- Toast Container -->
        <div id="toast-container" class="fixed bottom-5 right-5 z-[100] space-y-2"></div>

        <!-- Flash Messages as Toasts -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <script>
                    document.addEventListener('DOMContentLoaded', () => {
                        {% for category, message in messages %}
                            showToast('{{ message | safe }}', '{{ category }}', 6000);
                        {% endfor %}
                    });
                </script>
            {% endif %}
        {% endwith %}

        <!-- Service Status & Controls -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-10">
            <!-- Service Controls -->
            <div class="bg-white/70 backdrop-blur-xl shadow-lg rounded-2xl p-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Service Controls <span class="text-sm text-gray-500">(cloudflared)</span></h2>
                <div class="flex gap-3 flex-wrap">
                    <form action="{{ url_for('backup') }}" method="post">
                        <button type="submit" class="inline-flex items-center gap-2 px-4 py-2 bg-m-blue/80 hover:bg-m-blue text-m-purple-900 rounded-full text-sm font-medium transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <i class="material-icons-outlined text-base">backup</i> Backup Config
                        </button>
                    </form>
                    <form action="{{ url_for('restore') }}" method="post">
                        <button type="submit" class="inline-flex items-center gap-2 px-4 py-2 bg-m-teal/80 hover:bg-m-teal text-m-purple-900 rounded-full text-sm font-medium transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500">
                            <i class="material-icons-outlined text-base">restore</i> Restore Config
                        </button>
                    </form>
                    <form action="{{ url_for('test_providers') }}" method="post">
                        <button type="submit" class="inline-flex items-center gap-2 px-4 py-2 bg-m-purple-500 hover:bg-m-purple-600 text-white rounded-full text-sm font-medium transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-m-purple-400">
                            <i class="material-icons-outlined text-base">network_check</i> Test All Providers
                        </button>
                    </form>
                </div>
            </div>
            <!-- Service Status -->
            <div class="bg-white/70 backdrop-blur-xl shadow-lg rounded-2xl p-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Service Status</h2>
                <p class="text-sm text-gray-700">
                    <span class="font-medium">Current Provider:</span> {{ current_provider_name }}<br>
                    <span class="font-medium">Service Status:</span>
                    <span class="{% if service_status == 'running' %}text-green-800 font-medium{% else %}text-red-600{% endif %}">{{ service_status }}</span>
                </p>
            </div>
        </div>

        <!-- DoH Providers -->
        <div class="bg-white/70 backdrop-blur-xl shadow-lg rounded-2xl p-6 mb-10">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">DoH Providers</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50/50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">URL</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ping (ms)</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white/60 divide-y divide-gray-200/80">
                        {% for provider in providers %}
                            <tr class="{% if base_provider == provider.url or full_provider == provider.url %}bg-m-purple-50/50{% endif %} hover:bg-gray-50/50 transition-colors duration-100">
                                <td class="px-4 py-3 text-sm text-gray-900">{{ provider.name }}</td>
                                <td class="px-4 py-3 text-sm text-gray-500">{{ provider.url }}</td>
                                <td class="px-4 py-3 text-sm {% if test_results.get(provider.url, {}).get('ping', 'N/A') == 'Failed' %}text-red-600{% elif test_results.get(provider.url, {}).get('ping', 'N/A')|float < 50 %}text-green-600{% else %}text-gray-500{% endif %}">
                                    {{ test_results.get(provider.url, {}).get('ping', 'N/A') }}
                                </td>
                                <td class="px-4 py-3 text-sm flex gap-1">
                                    <form action="{{ url_for('select_provider') }}" method="post">
                                        <input type="hidden" name="url" value="{{ provider.url }}">
                                        <input type="hidden" name="name" value="{{ provider.name }}">
                                        <button type="submit" class="p-1 w-8 h-8 flex items-center justify-center rounded-full transition focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-green-500" title="Select {{ provider.name }}">
                                            <i class="material-icons-outlined text-lg leading-none text-green-600">check_circle_outline</i>
                                        </button>
                                    </form>
                                    <form action="{{ url_for('test_provider') }}" method="post">
                                        <input type="hidden" name="url" value="{{ provider.url }}">
                                        <input type="hidden" name="name" value="{{ provider.name }}">
                                        <button type="submit" class="p-1 w-8 h-8 flex items-center justify-center rounded-full transition focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-blue-500" title="Test {{ provider.name }}">
                                            <i class="material-icons-outlined text-lg leading-none text-m-blue">speed</i>
                                        </button>
                                    </form>
                                    {% if provider not in default_providers %}
                                        <form action="{{ url_for('delete_provider') }}" method="post">
                                            <input type="hidden" name="name" value="{{ provider.name }}">
                                            <input type="hidden" name="url" value="{{ provider.url }}">
                                            <button type="submit" class="p-1 w-8 h-8 flex items-center justify-center rounded-full transition focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-red-500" title="Delete {{ provider.name }}">
                                                <i class="material-icons-outlined text-lg leading-none text-red-600">delete</i>
                                            </button>
                                        </form>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Add Custom Provider -->
        <div class="bg-white/70 backdrop-blur-xl shadow-lg rounded-2xl p-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Add Custom Provider</h2>
            <form action="{{ url_for('add_provider') }}" method="post" class="flex gap-3 items-end">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Provider Name</label>
                    <input type="text" id="name" name="name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-m-purple-300 focus:border-m-purple-500 transition text-sm">
                </div>
                <div>
                    <label for="url" class="block text-sm font-medium text-gray-700 mb-1">DoH URL</label>
                    <input type="text" id="url" name="url" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-m-purple-300 focus:border-m-purple-500 transition text-sm">
                </div>
                <button type="submit" class="inline-flex items-center gap-2 px-4 py-2 bg-m-purple-500 hover:bg-m-purple-600 text-white rounded-full text-sm font-medium transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-m-purple-400">
                    <i class="material-icons-outlined text-base">add</i> Add Provider
                </button>
            </form>
        </div>
    </main>

    <!-- JavaScript for Toasts -->
    <script>
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            let baseClass = 'custom-toast';
            let typeClass = 'toast-info';
            let icon = 'info';

            switch (type) {
                case 'success': typeClass = 'toast-success'; icon = 'check_circle'; break;
                case 'danger': typeClass = 'toast-error'; icon = 'error'; break;
                case 'warning': typeClass = 'toast-warning'; icon = 'warning'; break;
            }

            toast.className = `${baseClass} ${typeClass}`;
            toast.innerHTML = `<i class="material-icons-outlined">${icon}</i><span>${message}</span>`;

            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove(), { once: true });
            }, duration);
        }
    </script>
</body>
</html>
